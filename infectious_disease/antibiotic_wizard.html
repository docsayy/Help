<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Antibiotic Wizard ‚Äî Infectious Disease</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --accent: #06b6d4; /* teal */
      --accent-soft: #e0f7fa;
      --accent-strong: #0284c7;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border-subtle: #d1d5db;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 12px 28px rgba(6, 182, 212, 0.18);
      --shadow-subtle: 0 4px 12px rgba(15, 23, 42, 0.08);
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top left, #e0f7fa 0, #f3f4f6 40%, #ffffff 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      justify-content: center;
      padding: 20px 12px 32px;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      background: rgba(255, 255, 255, 0.94);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 60px rgba(6, 182, 212, 0.2);
      backdrop-filter: blur(16px);
      padding: 20px 18px 26px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 24px 28px 32px;
      }
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 18px;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 16px;
    }

    @media (min-width: 640px) {
      header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    .title-block {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .system-icon {
      width: 52px;
      height: 52px;
      border-radius: 20px;
      background: radial-gradient(circle at 25% 20%, #ffffff 0, #a5f3fc 40%, #06b6d4 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 12px 28px rgba(6, 182, 212, 0.4);
      flex-shrink: 0;
    }

    .title-text h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      background: var(--accent-soft);
      color: var(--accent-strong);
      margin-top: 4px;
      font-weight: 600;
    }

    .title-text p {
      margin: 6px 0 0;
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
      color: var(--text-main);
      font-size: 0.85rem;
      text-decoration: none;
      cursor: pointer;
      box-shadow: var(--shadow-subtle);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #06b6d4, #0284c7);
      border-color: transparent;
      color: #ffffff;
      box-shadow: var(--shadow-soft);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
      background: #ffffff;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0ea5e9, #0369a1);
      box-shadow: 0 14px 32px rgba(14, 165, 233, 0.4);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 6px;
    }

    .section-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
    }

    @media (min-width: 900px) {
      .section-row {
        grid-template-columns: 1.1fr 1.1fr;
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow-subtle);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.16), transparent 55%);
      opacity: 0;
      transition: opacity var(--transition-fast);
      pointer-events: none;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-header {
      margin-bottom: 10px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-header p {
      margin: 4px 0 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      background: #e0f2fe;
      color: #1d4ed8;
      font-size: 0.75rem;
      border: 1px solid #bfdbfe;
    }

    .form-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px 12px;
    }

    @media (min-width: 640px) {
      .form-grid.two-col {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 3px;
      color: #0f172a;
    }

    .field {
      margin-bottom: 6px;
    }

    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 0.85rem;
      font-family: inherit;
      background: #f9fafb;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 1px rgba(6, 182, 212, 0.3);
      background: #ffffff;
    }

    .checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      margin-top: 4px;
    }

    .check-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.78rem;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
      cursor: pointer;
      user-select: none;
      transition: background var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .check-pill input {
      margin: 0;
    }

    .check-pill:hover {
      background: #eef2ff;
      border-color: #a5b4fc;
      box-shadow: 0 3px 8px rgba(129, 140, 248, 0.3);
    }

    .subtle-note {
      font-size: 0.74rem;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .section-divider {
      height: 1px;
      background: var(--border-subtle);
      margin: 6px 0 4px;
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn-run {
      padding: 9px 18px;
      border-radius: var(--radius-pill);
      border: none;
      background: linear-gradient(135deg, #06b6d4, #0ea5e9);
      color: #ffffff;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: var(--shadow-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .btn-run:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(6, 182, 212, 0.4);
      background: linear-gradient(135deg, #0ea5e9, #0369a1);
    }

    .btn-run:active {
      transform: translateY(0);
      box-shadow: var(--shadow-subtle);
    }

    .btn-secondary {
      border-radius: var(--radius-pill);
      padding: 7px 14px;
      border: 1px solid #bae6fd;
      background: #ecfeff;
      color: #0369a1;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(6, 182, 212, 0.16);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(6, 182, 212, 0.25);
      background: #e0f7fa;
    }

    .results-card {
      margin-top: 6px;
    }

    .results-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }

    @media (min-width: 900px) {
      .results-grid {
        grid-template-columns: 1.1fr 1fr;
      }
    }

    .results-section h3 {
      margin: 0 0 4px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .results-section h4 {
      margin: 6px 0 2px;
      font-size: 0.9rem;
    }

    .results-section p,
    .results-section li {
      font-size: 0.8rem;
      line-height: 1.4;
    }

    .tagline {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0369a1;
      border: 1px solid #bae6fd;
      font-size: 0.75rem;
    }

    ul {
      padding-left: 18px;
      margin: 4px 0 4px;
    }

    footer {
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-strong);
      display: inline-block;
      margin-right: 6px;
    }

    /* Modal for copy preview */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 16px 14px;
      max-width: 620px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.35);
      border: 1px solid #d1d5db;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 0.95rem;
    }

    .modal-header button {
      border: none;
      background: transparent;
      font-size: 1.1rem;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-body {
      margin-bottom: 8px;
    }

    .modal-body textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 0.8rem;
      padding: 8px;
      resize: vertical;
      min-height: 160px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #f9fafb;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
    }

    .copy-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-right: auto;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-block">
        <div class="system-icon" aria-hidden="true">üíä</div>
        <div class="title-text">
          <h1>Antibiotic Wizard</h1>
          <div class="badge">
            ü¶† Infectious Disease &bull; Empiric selection helper
          </div>
          <p>
            Combines patient factors, allergies, prior cultures, resistance risks, and infection sites to suggest guideline-informed empiric regimens.
          </p>
        </div>
      </div>
      <nav class="nav-buttons" aria-label="Page navigation">
        <a href="../index.html" class="btn btn-primary">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M12 3.172 3 10.5V20a1 1 0 0 0 1 1h6v-5h4v5h6a1 1 0 0 0 1-1v-9.5L12 3.172Z"/>
          </svg>
          <span>Home</span>
        </a>
        <a href="../infectious.html" class="btn">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M12 5.5 5.5 12l1.4 1.4L11 9.3V19h2V9.3l4.1 4.1 1.4-1.4L12 5.5Z"/>
          </svg>
          <span>Back to Infectious Disease</span>
        </a>
      </nav>
    </header>

    <main>
      <!-- TOP ROW: Patient/Setting + Allergies -->
      <div class="section-row">
        <!-- Patient & setting -->
        <section class="card">
          <div class="card-header">
            <h2>Patient &amp; Setting</h2>
            <p>Basic demographics and care setting to anchor guideline recommendations.</p>
          </div>
          <div class="form-grid two-col">
            <div class="field">
              <label for="age">Age (years)</label>
              <input type="number" id="age" min="0" max="120" />
            </div>
            <div class="field">
              <label for="sex">Sex</label>
              <select id="sex">
                <option value="">Select</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
                <option value="other">Other / NA</option>
              </select>
            </div>
            <div class="field">
              <label for="weight">Weight (kg) <span style="font-weight:400;color:var(--text-muted);">(optional)</span></label>
              <input type="number" id="weight" min="0" max="400" />
            </div>
            <div class="field">
              <label for="setting">Current setting / severity</label>
              <select id="setting">
                <option value="">Select</option>
                <option value="outpatient">Outpatient / ED discharge likely</option>
                <option value="inpatient">Inpatient (ward) / non-ICU</option>
                <option value="icu">ICU / severe illness (vasopressors or ventilation)</option>
              </select>
              <div class="subtle-note">
                ICU/severe generally aligns with severe CAP or septic shock.
              </div>
            </div>
          </div>

          <div class="section-divider"></div>

          <div class="form-grid">
            <div class="field">
              <label>Major comorbidities</label>
              <div class="checkbox-row">
                <label class="check-pill">
                  <input type="checkbox" id="comorbid-heart-lung" />
                  <span>Heart / lung disease</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="comorbid-liver-renal" />
                  <span>Liver / renal disease</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="comorbid-diabetes" />
                  <span>Diabetes</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="comorbid-alcohol" />
                  <span>Alcohol dependence</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="comorbid-malignancy" />
                  <span>Malignancy / asplenia</span>
                </label>
              </div>
              <div class="subtle-note">
                These count as ‚Äúcomorbidities‚Äù for CAP outpatient regimens.
              </div>
            </div>
            <div class="field">
              <label>Recent antibiotics &amp; healthcare exposure</label>
              <div class="checkbox-row">
                <label class="check-pill">
                  <input type="checkbox" id="abx-3mo" />
                  <span>Antibiotics &le; 3 months</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="iv-abx-90d" />
                  <span>IV antibiotics &le; 90 days</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="recent-hosp-30d" />
                  <span>Hospitalization &le; 30 days</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="nursing-home" />
                  <span>Nursing home / SNF</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="immunosuppressed" />
                  <span>Immunosuppressed</span>
                </label>
              </div>
            </div>
          </div>
        </section>

        <!-- Allergies & resistance / sites -->
        <section class="card">
          <div class="card-header">
            <h2>Allergies, Resistance &amp; Sites</h2>
            <p>Capture key allergy classes, prior resistant organisms, and suspected infection sites.</p>
          </div>

          <div class="field">
            <label>Drug allergies (by class)</label>
            <div class="checkbox-row">
              <label class="check-pill">
                <input type="checkbox" id="alg-pen" />
                <span>Penicillin</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="alg-ceph" />
                <span>Cephalosporin</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="alg-sulfa" />
                <span>Sulfa / TMP‚ÄìSMX</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="alg-fq" />
                <span>Fluoroquinolone</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="alg-macrolide" />
                <span>Macrolide</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="alg-carbapenem" />
                <span>Carbapenem</span>
              </label>
            </div>
            <div class="field" style="margin-top:4px;">
              <label for="allergy-notes">Allergy details (optional)</label>
              <textarea id="allergy-notes" placeholder="e.g., anaphylaxis to penicillin; mild rash with ceftriaxone; unclear sulfa reaction."></textarea>
            </div>
            <div class="subtle-note">
              This version flags potential conflicts rather than fully auto-removing all Œ≤-lactams ‚Äî always individualize based on reaction type.
            </div>
          </div>

          <div class="section-divider"></div>

          <div class="field">
            <label>Prior resistant organisms (any site)</label>
            <div class="checkbox-row">
              <label class="check-pill">
                <input type="checkbox" id="prior-mrsa" />
                <span>MRSA</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="prior-pseudo" />
                <span>Pseudomonas</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="prior-esbl" />
                <span>ESBL Enterobacterales</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="prior-ampc" />
                <span>AmpC producer</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="prior-vre" />
                <span>VRE / Enterococcus</span>
              </label>
            </div>
            <div class="subtle-note">
              Prior urine cultures with resistant organisms are especially important for UTI decisions.
            </div>
          </div>

          <div class="field">
            <label for="resistance-notes">Most relevant prior culture details (optional)</label>
            <textarea id="resistance-notes" placeholder="e.g., ESBL Klebsiella in urine 3 months ago; MRSA pneumonia 1 year ago"></textarea>
          </div>

          <div class="section-divider"></div>

          <div class="field">
            <label>Suspected infection sites (select one or more)</label>
            <div class="checkbox-row">
              <label class="check-pill">
                <input type="checkbox" id="site-pneumonia" />
                <span>ü´Å Pneumonia</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="site-uti" />
                <span>üíß UTI / Pyelo / CAUTI</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="site-ssti" />
                <span>ü©π Skin / soft tissue</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="site-iab" />
                <span>ü´ô Intra-abdominal</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="site-bacteremia" />
                <span>üß™ Bacteremia</span>
              </label>
              <label class="check-pill">
                <input type="checkbox" id="site-unknown" />
                <span>‚ùì Sepsis, source unclear</span>
              </label>
            </div>
            <div class="subtle-note">
              This version has detailed logic for pneumonia and UTI; other sites give structured prompts / reminders.
            </div>
          </div>
        </section>
      </div>

      <!-- SECOND ROW: Pneumonia + UTI details -->
      <div class="section-row">
        <!-- Pneumonia details -->
        <section class="card" id="pneumonia-details">
          <div class="card-header">
            <h2>ü´Å Pneumonia Details</h2>
            <p>Guideline-based CAP logic (NEJM 2023 + ATS/IDSA 2019; MRSA/Pseudomonas only with validated risk).</p>
          </div>
          <div class="form-grid two-col">
            <div class="field">
              <label for="pna-type">Pneumonia type (clinical)</label>
              <select id="pna-type">
                <option value="">Select</option>
                <option value="cap">Community-acquired (CAP)</option>
                <option value="hap">Hospital-acquired (HAP, non-vent)</option>
                <option value="vap">Ventilator-associated (VAP)</option>
              </select>
            </div>
            <div class="field">
              <label for="pna-severity">Clinical severity</label>
              <select id="pna-severity">
                <option value="">Match setting above</option>
                <option value="mild">Mild (likely outpatient)</option>
                <option value="moderate">Moderate (ward / non-ICU)</option>
                <option value="severe">Severe CAP (ICU / vasopressors or ventilation)</option>
              </select>
            </div>
            <div class="field">
              <label>MRSA risk factors</label>
              <div class="checkbox-row">
                <label class="check-pill">
                  <input type="checkbox" id="pna-mrsa-prior" />
                  <span>Prior MRSA respiratory isolation</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="pna-mrsa-ivabx" />
                  <span>IV antibiotics ‚â§ 90 days</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="pna-mrsa-flu" />
                  <span>Recent influenza-like illness</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="pna-mrsa-cavitary" />
                  <span>Cavitary infiltrate / empyema</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="pna-mrsa-esrd" />
                  <span>ESRD</span>
                </label>
              </div>
            </div>
            <div class="field">
              <label>Pseudomonas risk factors</label>
              <div class="checkbox-row">
                <label class="check-pill">
                  <input type="checkbox" id="pna-pseudo-prior" />
                  <span>Prior Pseudomonas isolation</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="pna-pseudo-ivabx" />
                  <span>IV antibiotics ‚â§ 90 days</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="pna-pseudo-bronch" />
                  <span>Bronchiectasis</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="pna-pseudo-copd" />
                  <span>Frequent COPD exacerbations</span>
                </label>
              </div>
              <div class="subtle-note">
                Strongest signals: prior isolation and recent parenteral antibiotics, particularly in severe CAP.
              </div>
            </div>
          </div>
          <div class="field">
            <label class="subtle-note">
              Macrolide monotherapy is generally <strong>not</strong> recommended in the U.S. because pneumococcal macrolide resistance &gt; 25%.
            </label>
          </div>
        </section>

        <!-- UTI details -->
        <section class="card" id="uti-details">
          <div class="card-header">
            <h2>üíß UTI / Pyelonephritis Details</h2>
            <p>IDSA-based UTI logic with ESBL/AmpC, catheter, MDR risk, and severity (cystitis vs pyelo vs cUTI).</p>
          </div>
          <div class="form-grid two-col">
            <div class="field">
              <label for="uti-type">UTI type</label>
              <select id="uti-type">
                <option value="">Select</option>
                <option value="uncomplicated-cystitis">Uncomplicated cystitis</option>
                <option value="pyelonephritis">Pyelonephritis</option>
                <option value="complicated">Complicated / CAUTI / sepsis</option>
              </select>
            </div>
            <div class="field">
              <label>UTI-specific risk factors</label>
              <div class="checkbox-row">
                <label class="check-pill">
                  <input type="checkbox" id="uti-male" />
                  <span>Male</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-catheter" />
                  <span>Indwelling Foley / suprapubic</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-recurrent" />
                  <span>Recurrent UTIs</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-transplant" />
                  <span>Renal transplant / urologic abnormality</span>
                </label>
              </div>
            </div>

            <div class="field">
              <label>Prior resistant urinary pathogens</label>
              <div class="checkbox-row">
                <label class="check-pill">
                  <input type="checkbox" id="uti-prior-esbl" />
                  <span>Prior ESBL-E in urine</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-prior-ampc" />
                  <span>Prior AmpC-E in urine</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-prior-pseudo" />
                  <span>Prior Pseudomonas in urine</span>
                </label>
              </div>
              <div class="subtle-note">
                When available, base empiric cUTI choices on the <strong>most recent urine culture</strong> plus local antibiogram.
              </div>
            </div>

            <div class="field">
              <label>MDR risk factors (for UTI)</label>
              <div class="checkbox-row">
                <label class="check-pill">
                  <input type="checkbox" id="uti-mdro-nh" />
                  <span>Nursing home residence</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-mdro-abx30" />
                  <span>Antibiotics ‚â§ 30 days</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-mdro-hosp30" />
                  <span>Hospitalization ‚â§ 30 days</span>
                </label>
                <label class="check-pill">
                  <input type="checkbox" id="uti-mdro-catheter" />
                  <span>Indwelling urinary catheter</span>
                </label>
              </div>
              <div class="subtle-note">
                ‚â•2 risk factors substantially lower susceptibility to FQ and some cephalosporins.
              </div>
            </div>
          </div>
          <div class="field">
            <label for="uti-notes">Urinary tract notes (optional)</label>
            <textarea id="uti-notes" placeholder="e.g., recently exchanged Foley; prior ESBL E. coli; nitrofurantoin allergy"></textarea>
          </div>
        </section>
      </div>

      <!-- ACTIONS -->
      <div class="actions-row">
        <button type="button" class="btn-run" onclick="runWizard()">
          <span>Generate empiric plan</span> ‚ñ∏
        </button>
        <button type="button" class="btn-secondary" onclick="openCopyModal()">
          üìã Preview &amp; copy full plan
        </button>
      </div>

      <!-- RESULTS -->
      <section class="card results-card">
        <div class="card-header">
          <h2>Suggested Empiric Plan &amp; Rationale</h2>
          <p class="tagline">
            <span class="chip">‚ö†Ô∏è Clinical judgment required</span>
            These outputs are educational &amp; for bedside thinking support ‚Äî not a substitute for local guidelines or ID consult.
          </p>
        </div>
        <div class="results-grid">
          <div class="results-section" id="results-summary">
            <h3>üß≠ Summary</h3>
            <div id="summary-content">
              <p>Fill in patient details, select infection sites, and click ‚ÄúGenerate empiric plan.‚Äù</p>
            </div>

            <h3 style="margin-top:10px;">üß™ Cultures &amp; Diagnostics</h3>
            <div id="diagnostics-content">
              <p>Recommendations for cultures, MRSA swab, and imaging will appear here.</p>
            </div>
          </div>
          <div class="results-section" id="results-antibiotics">
            <h3>üíä Empiric Antibiotics &amp; Reasons</h3>
            <div id="abx-content">
              <p>Site-specific empiric suggestions will appear here, including brief reasons for each regimen and de-escalation prompts.</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div><span class="dot"></span>Light teal Infectious Disease theme. No dark mode.</div>
      <div>Logic focuses on pneumonia &amp; UTI first; other sites to be expanded later.</div>
    </footer>
  </div>

  <!-- COPY MODAL -->
  <div class="modal-overlay" id="copy-modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="copy-modal-title">
      <div class="modal-header">
        <h3 id="copy-modal-title">Preview &amp; copy plan</h3>
        <button type="button" onclick="closeCopyModal()" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <textarea id="copy-modal-textarea" readonly></textarea>
      </div>
      <div class="modal-footer">
        <span class="copy-hint">This is plain text for easy paste into notes or sign-out.</span>
        <button type="button" class="btn-secondary" onclick="copyPlanToClipboard()">Copy to clipboard</button>
      </div>
    </div>
  </div>

  <script>
    let currentPlanText = "";

    function anyChecked(ids) {
      return ids.some(id => document.getElementById(id)?.checked);
    }

    function countChecked(ids) {
      return ids.reduce((acc, id) => acc + (document.getElementById(id)?.checked ? 1 : 0), 0);
    }

    function getSetting() {
      return document.getElementById("setting").value;
    }

    function hasMajorComorbidities() {
      return anyChecked([
        "comorbid-heart-lung",
        "comorbid-liver-renal",
        "comorbid-diabetes",
        "comorbid-alcohol",
        "comorbid-malignancy"
      ]);
    }

    function getAllergySummary() {
      const classes = [];
      if (document.getElementById("alg-pen").checked) classes.push("penicillin");
      if (document.getElementById("alg-ceph").checked) classes.push("cephalosporin");
      if (document.getElementById("alg-sulfa").checked) classes.push("sulfa / TMP‚ÄìSMX");
      if (document.getElementById("alg-fq").checked) classes.push("fluoroquinolone");
      if (document.getElementById("alg-macrolide").checked) classes.push("macrolide");
      if (document.getElementById("alg-carbapenem").checked) classes.push("carbapenem");
      const notes = document.getElementById("allergy-notes").value.trim();

      let text = "";
      if (classes.length) {
        text += "Reported allergy classes: " + classes.join(", ") + ". ";
      } else {
        text += "No drug allergy classes selected. ";
      }
      if (notes) {
        text += "Allergy notes: " + notes + ".";
      }
      return text;
    }

    function buildPneumoniaPlan() {
      const siteSelected = document.getElementById("site-pneumonia").checked;
      if (!siteSelected) return { summaryHtml: "", abxHtml: "", textSummary: "", textAbx: "" };

      const setting = getSetting();
      const pnaType = document.getElementById("pna-type").value || "cap";
      const pnaSeverity = document.getElementById("pna-severity").value;
      const comorbid = hasMajorComorbidities();
      const abx3mo = document.getElementById("abx-3mo").checked;
      const ivabx90 = document.getElementById("iv-abx-90d").checked;

      const mrsaStrong = document.getElementById("pna-mrsa-prior").checked;
      const mrsaWeakCount = countChecked([
        "pna-mrsa-ivabx",
        "pna-mrsa-flu",
        "pna-mrsa-cavitary",
        "pna-mrsa-esrd"
      ]);

      const pseudoStrong = document.getElementById("pna-pseudo-prior").checked;
      const pseudoWeakCount = countChecked([
        "pna-pseudo-ivabx",
        "pna-pseudo-bronch",
        "pna-pseudo-copd"
      ]);

      const algPen = document.getElementById("alg-pen").checked;
      const algCeph = document.getElementById("alg-ceph").checked;
      const algMacrolide = document.getElementById("alg-macrolide").checked;
      const algFq = document.getElementById("alg-fq").checked;

      let summaryParts = [];
      let summaryTextParts = [];

      summaryParts.push("<strong>Pneumonia:</strong> " + pnaType.toUpperCase() + " with " +
        (pnaSeverity ? pnaSeverity + " severity." : "severity approximated from setting."));
      summaryTextParts.push("Pneumonia: " + pnaType.toUpperCase() + ", " +
        (pnaSeverity ? pnaSeverity + " severity." : "severity approximated from setting."));

      if (comorbid) {
        summaryParts.push("Has guideline-defined CAP comorbidities.");
        summaryTextParts.push("Guideline-defined CAP comorbidities present.");
      }
      if (abx3mo) {
        summaryParts.push("Antibiotic exposure within 3 months.");
        summaryTextParts.push("Antibiotic exposure within 3 months.");
      }
      if (ivabx90) {
        summaryParts.push("IV antibiotics within 90 days.");
        summaryTextParts.push("IV antibiotics within 90 days.");
      }
      if (mrsaStrong) {
        summaryParts.push("Strong MRSA risk (prior MRSA respiratory isolation).");
        summaryTextParts.push("Strong MRSA risk: prior MRSA respiratory isolation.");
      }
      if (mrsaWeakCount && !mrsaStrong) {
        summaryParts.push("Weak MRSA risk factors present.");
        summaryTextParts.push("Weak MRSA risk factors present.");
      }
      if (pseudoStrong) {
        summaryParts.push("Strong Pseudomonas risk (prior isolation).");
        summaryTextParts.push("Strong Pseudomonas risk: prior isolation.");
      }
      if (pseudoWeakCount && !pseudoStrong) {
        summaryParts.push("Weak Pseudomonas risk factors present.");
        summaryTextParts.push("Weak Pseudomonas risk factors present.");
      }

      let abxHtml = "";
      let abxTextLines = [];

      function addRegimen(titleHtml, titleText, bulletsHtml, bulletsText, reasonsHtml, reasonsText) {
        abxHtml += "<h4>" + titleHtml + "</h4><ul>" + bulletsHtml.join("") + "</ul>";
        if (reasonsHtml && reasonsHtml.length) {
          abxHtml += "<ul>" + reasonsHtml.join("") + "</ul>";
        }
        abxTextLines.push(titleText);
        bulletsText.forEach(line => abxTextLines.push("  - " + line));
        if (reasonsText && reasonsText.length) {
          reasonsText.forEach(line => abxTextLines.push("    ‚Ä¢ Reason: " + line));
        }
      }

      if (pnaType === "cap" && setting === "outpatient") {
        if (!comorbid && !abx3mo) {
          // Outpatient CAP, low risk
          const bulletsHtml = [
            "<li><strong>Preferred:</strong> Amoxicillin 1 g PO TID.</li>",
            "<li>Alternative: Doxycycline 100 mg PO BID.</li>",
            "<li><strong>Avoid</strong> macrolide monotherapy in the U.S. due to high pneumococcal macrolide resistance (&gt;25%).</li>"
          ];
          const bulletsText = [
            "Preferred: Amoxicillin 1 g PO TID.",
            "Alternative: Doxycycline 100 mg PO BID.",
            "Avoid macrolide monotherapy in the U.S. due to high macrolide resistance."
          ];
          const reasonsHtml = [
            "<li><em>Why amoxicillin?</em> Strong pneumococcal coverage; guideline-preferred for low-risk outpatient CAP.</li>",
            "<li><em>Why doxycycline?</em> Covers typical and atypical CAP pathogens; useful if Œ≤-lactam not ideal.</li>"
          ];
          const reasonsText = [
            "Amoxicillin: strong pneumococcal coverage; guideline-preferred for low-risk outpatient CAP.",
            "Doxycycline: covers typical and atypical pathogens; good alternative if Œ≤-lactam not ideal."
          ];
          addRegimen("Outpatient CAP, no comorbidities, no recent antibiotics", "Outpatient CAP, no comorbidities, no recent antibiotics:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        } else {
          const bulletsHtml = [
            "<li><strong>Preferred:</strong> Amoxicillin‚Äìclavulanate (e.g., 875 mg PO BID) plus azithromycin or doxycycline.</li>",
            "<li><strong>Alternative:</strong> Respiratory fluoroquinolone (levofloxacin 750 mg PO daily or moxifloxacin 400 mg PO daily) if Œ≤-lactam + macrolide/doxy cannot be used.</li>"
          ];
          const bulletsText = [
            "Preferred: Amoxicillin‚Äìclavulanate (e.g., 875 mg PO BID) plus azithromycin or doxycycline.",
            "Alternative: Respiratory fluoroquinolone (levofloxacin 750 mg PO daily or moxifloxacin 400 mg PO daily) if Œ≤-lactam + macrolide/doxy cannot be used."
          ];
          const reasonsHtml = [
            "<li><em>Why amox‚Äìclav + macrolide/doxy?</em> Combines pneumococcal coverage with atypical coverage; matches ATS/IDSA regimen for comorbid outpatient CAP.</li>",
            "<li><em>Why FQ only as alternative?</em> Effective but higher risk of C. difficile, resistance, and tendon toxicity.</li>"
          ];
          const reasonsText = [
            "Amox‚Äìclav + macrolide/doxy: guideline-recommended for outpatient CAP with comorbidities; broad pneumococcal and atypical coverage.",
            "Fluoroquinolone: effective single-agent option but should be reserved due to C. diff, resistance, and tendon risks."
          ];
          addRegimen("Outpatient CAP with comorbidities and/or recent antibiotics", "Outpatient CAP with comorbidities and/or recent antibiotics:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        }
      } else if (pnaType === "cap" && (setting === "inpatient" || setting === "icu")) {
        const severe = (pnaSeverity === "severe" || setting === "icu");

        if (!severe) {
          const bulletsHtml = [
            "<li><strong>Preferred:</strong> Ceftriaxone (or similar IV Œ≤-lactam) plus azithromycin.</li>",
            "<li><strong>Alternative:</strong> Respiratory fluoroquinolone monotherapy if Œ≤-lactam + macrolide cannot be used.</li>"
          ];
          const bulletsText = [
            "Preferred: Ceftriaxone (or similar IV Œ≤-lactam) plus azithromycin.",
            "Alternative: Respiratory fluoroquinolone monotherapy if Œ≤-lactam + macrolide cannot be used."
          ];
          const reasonsHtml = [
            "<li><em>Why ceftriaxone + azithro?</em> Strong evidence for improved outcomes; covers typical plus atypical pathogens.</li>",
            "<li><em>Why FQ alternative?</em> Useful monotherapy when Œ≤-lactam or macrolide contraindicated.</li>"
          ];
          const reasonsText = [
            "Ceftriaxone + azithro: standard inpatient CAP regimen with data for improved outcomes.",
            "Fluoroquinolone monotherapy: covers typical and atypical pathogens when Œ≤-lactam or macrolide cannot be used."
          ];
          addRegimen("Hospitalized non-severe CAP (ward / non-ICU)", "Hospitalized non-severe CAP (ward / non-ICU):", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        } else {
          const bulletsHtml = [
            "<li><strong>Preferred:</strong> IV Œ≤-lactam (e.g., ceftriaxone, cefotaxime, or ampicillin‚Äìsulbactam) plus azithromycin.</li>",
            "<li><strong>Alternative:</strong> Œ≤-lactam plus respiratory fluoroquinolone.</li>"
          ];
          const bulletsText = [
            "Preferred: IV Œ≤-lactam (e.g., ceftriaxone, cefotaxime, or ampicillin‚Äìsulbactam) plus azithromycin.",
            "Alternative: Œ≤-lactam plus respiratory fluoroquinolone."
          ];
          const reasonsHtml = [
            "<li><em>Why Œ≤-lactam + macrolide?</em> Best mortality and outcome data in severe CAP; macrolide adds atypical coverage and immunomodulatory effect.</li>",
            "<li><em>Why Œ≤-lactam + FQ?</em> Alternative when macrolides cannot be used.</li>"
          ];
          const reasonsText = [
            "Œ≤-lactam + macrolide: preferred in severe CAP with mortality benefit in studies.",
            "Œ≤-lactam + FQ: alternative combination if macrolide is contraindicated."
          ];
          addRegimen("Severe CAP (ICU / vasopressors or ventilation)", "Severe CAP (ICU / vasopressors or ventilation):", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        }

        // MRSA coverage
        if (mrsaStrong || (severe && (mrsaWeakCount || ivabx90))) {
          const bulletsHtml = [
            "<li>Add vancomycin (dose per weight/renal function, monitor levels) or linezolid 600 mg IV/PO q12h while cultures are pending.</li>",
            "<li>Obtain MRSA nasal swab; if negative and no other strong risk, consider stopping MRSA coverage (NPV ~99% for CAP).</li>"
          ];
          const bulletsText = [
            "Add vancomycin or linezolid empirically while cultures are pending.",
            "Order MRSA nasal swab; if negative and no other strong risk, consider stopping MRSA coverage."
          ];
          const reasonsHtml = [
            "<li><em>Why vancomycin/linezolid?</em> Target MRSA specifically; linezolid may have better lung penetration.</li>"
          ];
          const reasonsText = [
            "Vancomycin/linezolid: provide targeted MRSA coverage in high-risk severe CAP."
          ];
          addRegimen("MRSA coverage", "MRSA coverage:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        } else if (mrsaWeakCount) {
          abxHtml += "<p><strong>MRSA note:</strong> Weak MRSA risk factors present; consider empiric coverage case-by-case rather than automatic for all patients.</p>";
          abxTextLines.push("MRSA note: weak MRSA risk factors present; consider empiric coverage case-by-case.");
        }

        // Pseudomonas coverage
        if (pseudoStrong || (severe && (pseudoWeakCount || ivabx90))) {
          const bulletsHtml = [
            "<li>Use an antipseudomonal Œ≤-lactam such as piperacillin‚Äìtazobactam, cefepime, ceftazidime, aztreonam, meropenem, or imipenem based on local antibiogram and allergy profile.</li>",
            "<li>Reserve dual antipseudomonal therapy for hemodynamic instability or very high risk of resistance.</li>"
          ];
          const bulletsText = [
            "Use an antipseudomonal Œ≤-lactam (e.g., pip‚Äìtazo, cefepime, ceftazidime, aztreonam, meropenem, or imipenem) guided by local data.",
            "Consider dual antipseudomonal therapy only if unstable or very high resistance risk."
          ];
          const reasonsHtml = [
            "<li><em>Why antipseudomonal Œ≤-lactam?</em> Provides reliable coverage for Pseudomonas in high-risk severe CAP.</li>"
          ];
          const reasonsText = [
            "Antipseudomonal Œ≤-lactam: necessary when strong Pseudomonas risk or severe disease plus risk factors."
          ];
          addRegimen("Pseudomonas coverage", "Pseudomonas coverage:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        } else if (pseudoWeakCount) {
          abxHtml += "<p><strong>Pseudomonas note:</strong> Weak Pseudomonas risk factors present; use prior cultures and unit antibiogram to decide whether to broaden empirically.</p>";
          abxTextLines.push("Pseudomonas note: weak Pseudomonas risk factors present; use prior cultures and unit antibiogram to decide whether to broaden.");
        }
      } else {
        // HAP/VAP placeholder
        abxHtml += "<h4>HAP / VAP (simplified placeholder)</h4>";
        abxHtml += "<p>For HAP/VAP, base empiric regimen on prior respiratory cultures, local ICU antibiogram, and MRSA/Pseudomonas risk. " +
          "A typical backbone is an antipseudomonal Œ≤-lactam ¬± MRSA agent if strong risk factors are present.</p>";
        abxTextLines.push("HAP/VAP: use prior respiratory cultures and ICU antibiogram; typical backbone is antipseudomonal Œ≤-lactam ¬± MRSA agent.");
      }

      // Allergy considerations specific to pneumonia Œ≤-lactams/macrolides/FQs
      const allergyNotes = [];
      if ((algPen || algCeph) && /cef|amox|ampicillin|piperacillin|meropenem|imipenem|tazobactam|sulbactam/i.test(abxHtml)) {
        allergyNotes.push("Penicillin/cephalosporin allergy selected; verify severity before using Œ≤-lactams such as amoxicillin, amox‚Äìclav, ceftriaxone, or pip‚Äìtazo.");
      }
      if (algMacrolide && /azithro|macrolide/i.test(abxHtml)) {
        allergyNotes.push("Macrolide allergy selected; avoid azithromycin/clarithromycin and favor doxycycline or Œ≤-lactam + non-macrolide combinations.");
      }
      if (algFq && /fluoroquinolone|levofloxacin|moxifloxacin|ciprofloxacin/i.test(abxHtml)) {
        allergyNotes.push("Fluoroquinolone allergy selected; avoid levofloxacin, moxifloxacin, ciprofloxacin.");
      }
      if (allergyNotes.length) {
        abxHtml += "<p><strong>Allergy considerations (pneumonia):</strong></p><ul>";
        allergyNotes.forEach(n => abxHtml += "<li>" + n + "</li>");
        abxHtml += "</ul>";
        allergyNotes.forEach(n => abxTextLines.push("Allergy note (pneumonia): " + n));
      }

      return {
        summaryHtml: summaryParts.join(" "),
        abxHtml,
        textSummary: summaryTextParts.join(" "),
        textAbx: abxTextLines.join("\n")
      };
    }

    function buildUtiPlan() {
      const siteSelected = document.getElementById("site-uti").checked;
      if (!siteSelected) return { summaryHtml: "", abxHtml: "", textSummary: "", textAbx: "" };

      const utiType = document.getElementById("uti-type").value;
      const setting = getSetting();

      const male = document.getElementById("uti-male").checked;
      const catheter = document.getElementById("uti-catheter").checked || document.getElementById("uti-mdro-catheter").checked;
      const recurrent = document.getElementById("uti-recurrent").checked;
      const transplant = document.getElementById("uti-transplant").checked;

      const priorESBLurine = document.getElementById("uti-prior-esbl").checked || document.getElementById("prior-esbl").checked;
      const priorAmpCurine = document.getElementById("uti-prior-ampc").checked || document.getElementById("prior-ampc").checked;
      const priorPseudoUrine = document.getElementById("uti-prior-pseudo").checked || document.getElementById("prior-pseudo").checked;

      const mdroRiskCount = countChecked([
        "uti-mdro-nh",
        "uti-mdro-abx30",
        "uti-mdro-hosp30",
        "uti-mdro-catheter"
      ]);

      const abx3mo = document.getElementById("abx-3mo").checked;
      const ivabx90 = document.getElementById("iv-abx-90d").checked;
      const recentSevere = (setting === "icu");

      const algSulfa = document.getElementById("alg-sulfa").checked;
      const algFq = document.getElementById("alg-fq").checked;
      const algPen = document.getElementById("alg-pen").checked;
      const algCeph = document.getElementById("alg-ceph").checked;
      const algCarb = document.getElementById("alg-carbapenem").checked;

      let summaryParts = [];
      let summaryTextParts = [];
      let abxHtml = "";
      let abxTextLines = [];

      summaryParts.push("<strong>UTI:</strong> " + (utiType || "type not specified") + ".");
      summaryTextParts.push("UTI: " + (utiType || "type not specified") + ".");

      if (male) {
        summaryParts.push("Patient is male (UTI often considered complicated).");
        summaryTextParts.push("Male patient: UTI often considered complicated.");
      }
      if (catheter) {
        summaryParts.push("Indwelling urinary catheter / CAUTI scenario.");
        summaryTextParts.push("Indwelling urinary catheter / CAUTI scenario.");
      }
      if (recurrent) {
        summaryParts.push("History of recurrent UTIs.");
        summaryTextParts.push("History of recurrent UTIs.");
      }
      if (transplant) {
        summaryParts.push("Renal transplant / urologic abnormality.");
        summaryTextParts.push("Renal transplant / urologic abnormality.");
      }
      if (priorESBLurine) {
        summaryParts.push("Prior ESBL-producing Enterobacterales in urine.");
        summaryTextParts.push("Prior ESBL-producing Enterobacterales in urine.");
      }
      if (priorAmpCurine) {
        summaryParts.push("Prior AmpC-producing Enterobacterales in urine.");
        summaryTextParts.push("Prior AmpC-producing Enterobacterales in urine.");
      }
      if (priorPseudoUrine) {
        summaryParts.push("Prior Pseudomonas UTI.");
        summaryTextParts.push("Prior Pseudomonas UTI.");
      }
      if (mdroRiskCount >= 2) {
        summaryParts.push("Multiple MDR risk factors; lower susceptibility to FQ and some cephalosporins expected.");
        summaryTextParts.push("Multiple MDR risk factors; FQ and cephalosporin susceptibility likely reduced.");
      } else if (mdroRiskCount === 1) {
        summaryParts.push("Single MDR risk factor; mild reduction in susceptibility possible.");
        summaryTextParts.push("Single MDR risk factor; susceptibility may be slightly reduced.");
      }

      function addRegimen(titleHtml, titleText, bulletsHtml, bulletsText, reasonsHtml, reasonsText) {
        abxHtml += "<h4>" + titleHtml + "</h4><ul>" + bulletsHtml.join("") + "</ul>";
        if (reasonsHtml && reasonsHtml.length) {
          abxHtml += "<ul>" + reasonsHtml.join("") + "</ul>";
        }
        abxTextLines.push(titleText);
        bulletsText.forEach(line => abxTextLines.push("  - " + line));
        if (reasonsText && reasonsText.length) {
          reasonsText.forEach(line => abxTextLines.push("    ‚Ä¢ Reason: " + line));
        }
      }

      if (utiType === "uncomplicated-cystitis") {
        if (priorESBLurine || priorAmpCurine) {
          const bulletsHtml = [
            "<li><strong>Preferred:</strong> Nitrofurantoin or TMP‚ÄìSMX if the organism is susceptible and renal function allows.</li>",
            "<li><strong>Alternatives:</strong> Single-dose IV aminoglycoside; carbapenem or FQ if no safer options and high risk of clinical failure.</li>",
            "<li><strong>Avoid routine:</strong> Broad-spectrum carbapenems or FQ if narrower oral options are active.</li>"
          ];
          const bulletsText = [
            "Preferred: Nitrofurantoin or TMP‚ÄìSMX if susceptible and renal function allows.",
            "Alternatives: Single-dose IV aminoglycoside; carbapenem or fluoroquinolone if no safer options and high risk of failure.",
            "Avoid routine: Broad carbapenem or FQ if narrower active oral options exist."
          ];
          const reasonsHtml = [
            "<li><em>Why nitrofurantoin/TMP‚ÄìSMX?</em> Active against many ESBL/AmpC cystitis isolates and spares broader IV agents.</li>",
            "<li><em>Why limit carbapenems/FQ?</em> Preserve them for severe or resistant infections and reduce toxicity.</li>"
          ];
          const reasonsText = [
            "Nitrofurantoin/TMP‚ÄìSMX: often active for ESBL/AmpC cystitis and avoid overuse of broad IV agents.",
            "Carbapenem/FQ limitation: preserves these agents and reduces toxicity when narrower options work."
          ];
          addRegimen("Uncomplicated cystitis with ESBL/AmpC history", "Uncomplicated cystitis with ESBL/AmpC history:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        } else {
          const bulletsHtml = [
            "<li><strong>Preferred:</strong> Nitrofurantoin (if CrCl adequate) or TMP‚ÄìSMX when local resistance is acceptable and no contraindications.</li>",
            "<li><strong>Alternatives:</strong> Oral fosfomycin for <em>E. coli</em> cystitis; first-generation cephalosporin in some schemas.</li>",
            "<li><strong>Avoid:</strong> Fluoroquinolones for simple cystitis unless other options are not feasible.</li>"
          ];
          const bulletsText = [
            "Preferred: Nitrofurantoin (if CrCl adequate) or TMP‚ÄìSMX when resistance is acceptable.",
            "Alternatives: Oral fosfomycin for E. coli cystitis; first-generation cephalosporin in some schemas.",
            "Avoid: Fluoroquinolones for simple cystitis unless no other options."
          ];
          const reasonsHtml = [
            "<li><em>Why nitrofurantoin?</em> High urinary concentrations, excellent efficacy for lower UTI, and minimal systemic effects.</li>",
            "<li><em>Why limit FQ?</em> Reduce risk of C. difficile, resistance, and tendon toxicity for uncomplicated infections.</li>"
          ];
          const reasonsText = [
            "Nitrofurantoin: high urinary levels and good efficacy for lower UTI with minimal systemic toxicity.",
            "FQ restriction: mitigates C. diff, resistance, and tendon rupture risk for simple cystitis."
          ];
          addRegimen("Uncomplicated cystitis", "Uncomplicated cystitis:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        }
      } else if (utiType === "pyelonephritis") {
        if (priorESBLurine || priorAmpCurine || mdroRiskCount >= 2 || ivabx90 || recentSevere) {
          const bulletsHtml = [
            "<li><strong>Preferred when ESBL/AmpC or high MDR risk:</strong> TMP‚ÄìSMX, ciprofloxacin, or levofloxacin if susceptible; cefepime as preferred IV for AmpC-E when FQ/TMP‚ÄìSMX cannot be used.</li>",
            "<li>If high risk of ESBL with limited options, consider a carbapenem (e.g., ertapenem, meropenem) as initial empiric therapy pending culture.</li>",
            "<li><strong>Avoid:</strong> Nitrofurantoin and oral fosfomycin for pyelonephritis (insufficient renal tissue levels).</li>"
          ];
          const bulletsText = [
            "Preferred for ESBL/AmpC or MDR risk: TMP‚ÄìSMX, ciprofloxacin, or levofloxacin if susceptible; cefepime for AmpC-E when others cannot be used.",
            "Carbapenem (ertapenem, meropenem) reasonable empiric choice if ESBL risk is high and options limited.",
            "Avoid nitrofurantoin/fosfomycin for pyelonephritis (poor renal tissue penetration)."
          ];
          const reasonsHtml = [
            "<li><em>Why TMP‚ÄìSMX/FQ/cefepime?</em> Achieve high kidney tissue levels and are effective for upper tract infections.</li>",
            "<li><em>Why carbapenem?</em> Reliable initial agent for ESBL-related pyelonephritis until susceptibilities return.</li>"
          ];
          const reasonsText = [
            "TMP‚ÄìSMX/FQ/cefepime: high renal tissue levels suitable for pyelonephritis.",
            "Carbapenem: reliable agent when ESBL risk is high and other options are limited."
          ];
          addRegimen("Pyelonephritis with MDR/ESBL risk", "Pyelonephritis with MDR/ESBL risk:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        } else {
          const bulletsHtml = [
            "<li><strong>Preferred (if local FQ resistance &lt;10% and no recent FQ use):</strong> Oral ciprofloxacin or levofloxacin, or TMP‚ÄìSMX if susceptible.</li>",
            "<li><strong>IV option:</strong> Ceftriaxone for hospitalized patients without MDR risk.</li>",
            "<li><strong>Avoid:</strong> Nitrofurantoin and oral fosfomycin (inadequate kidney levels).</li>"
          ];
          const bulletsText = [
            "Preferred: Oral fluoroquinolone or TMP‚ÄìSMX if susceptible and resistance is low.",
            "IV option: Ceftriaxone for hospitalized patients without MDR risk.",
            "Avoid nitrofurantoin/fosfomycin for pyelonephritis (inadequate tissue penetration)."
          ];
          const reasonsHtml = [
            "<li><em>Why FQ/TMP‚ÄìSMX?</em> Well-studied with high clinical cure rates in pyelonephritis when susceptible.</li>",
            "<li><em>Why ceftriaxone?</em> Reliable IV option for hospitalized pyelo without MDR risk.</li>"
          ];
          const reasonsText = [
            "FQ/TMP‚ÄìSMX: high clinical success rates for pyelonephritis when organism is susceptible.",
            "Ceftriaxone: stable IV backbone for pyelonephritis in non-MDR patients."
          ];
          addRegimen("Pyelonephritis", "Pyelonephritis:", bulletsHtml, bulletsText, reasonsHtml, reasonsText);
        }
        abxHtml += "<p>Treatment duration is typically 7‚Äì14 days depending on agent, sex, and response; shorter courses (~7 days) are often adequate in men with febrile UTI using highly active agents.</p>";
        abxTextLines.push("Treatment duration: typically 7‚Äì14 days; ~7 days often adequate in men with febrile UTI using highly active agents.");
      } else if (utiType === "complicated" || setting === "icu") {
        const bulletsHtml = [
          "<li>Always replace or remove the catheter when feasible before culturing and starting antibiotics.</li>",
          "<li>Use the most recent urine culture to choose empiric therapy targeting likely pathogen (ESBL-E, AmpC-E, Pseudomonas, Enterococcus, etc.).</li>",
          "<li>In sepsis or shock, avoid under-treatment but be ready to narrow quickly as culture data return.</li>"
        ];
        const bulletsText = [
          "Replace/remove catheter before culturing and starting antibiotics when feasible.",
          "Use the most recent urine culture to choose empiric therapy for likely pathogens.",
          "In sepsis or shock, avoid under-treatment but narrow rapidly based on cultures."
        ];
        addRegimen("Complicated UTI / CAUTI / urosepsis", "Complicated UTI / CAUTI / urosepsis:", bulletsHtml, bulletsText, [], []);

        if (priorESBLurine || priorAmpCurine || mdroRiskCount >= 2 || ivabx90) {
          const bulletsHtml2 = [
            "<li><strong>High MDR or ESBL/AmpC risk:</strong> Carbapenem (e.g., meropenem, imipenem, or ertapenem for ESBL without Pseudomonas risk) as initial empiric therapy is reasonable while awaiting susceptibilities.</li>",
            "<li>Newer agents (e.g., ceftazidime‚Äìavibactam, meropenem‚Äìvaborbactam, ceftolozane‚Äìtazobactam, cefiderocol, plazomicin) should be reserved for documented or highly suspected difficult-to-treat resistant Gram-negatives.</li>"
          ];
          const bulletsText2 = [
            "High MDR/ESBL/AmpC risk: Carbapenem (meropenem, imipenem, or ertapenem if no Pseudomonas risk) is reasonable initial empiric therapy.",
            "Reserve newer agents (e.g., ceftazidime‚Äìavibactam, cefiderocol) for difficult-to-treat resistant Gram-negatives."
          ];
          const reasonsHtml2 = [
            "<li><em>Why carbapenem?</em> Reliable initial coverage for ESBL-related cUTI until susceptibilities are available.</li>"
          ];
          const reasonsText2 = [
            "Carbapenem: reliable initial coverage for ESBL/MDR cUTI while awaiting susceptibilities."
          ];
          addRegimen("Empiric choices for MDR/ESBL cUTI", "Empiric choices for MDR/ESBL cUTI:", bulletsHtml2, bulletsText2, reasonsHtml2, reasonsText2);
        } else if (priorPseudoUrine) {
          const bulletsHtml3 = [
            "<li><strong>Suspected Pseudomonas UTI:</strong> Piperacillin‚Äìtazobactam, cefepime, ceftazidime, or another antipseudomonal Œ≤-lactam guided by local antibiogram.</li>"
          ];
          const bulletsText3 = [
            "Suspected Pseudomonas UTI: use pip‚Äìtazo, cefepime, ceftazidime, or other antipseudomonal Œ≤-lactam guided by local data."
          ];
          const reasonsHtml3 = [
            "<li><em>Why antipseudomonal Œ≤-lactam?</em> Provides appropriate coverage when Pseudomonas is documented or strongly suspected.</li>"
          ];
          const reasonsText3 = [
            "Antipseudomonal Œ≤-lactam: ensures coverage when Pseudomonas is likely or documented."
          ];
          addRegimen("Pseudomonas-focused cUTI regimen", "Pseudomonas-focused cUTI regimen:", bulletsHtml3, bulletsText3, reasonsHtml3, reasonsText3);
        } else {
          const bulletsHtml4 = [
            "<li><strong>No strong MDR risk:</strong> Ceftriaxone ¬± gentamicin or piperacillin‚Äìtazobactam are common IV backbones for cUTI/urosepsis tailored to local susceptibility patterns.</li>"
          ];
          const bulletsText4 = [
            "No strong MDR risk: ceftriaxone ¬± gentamicin or pip‚Äìtazo are common IV backbones for cUTI/urosepsis, guided by local susceptibility."
          ];
          const reasonsHtml4 = [
            "<li><em>Why ceftriaxone/pip‚Äìtazo?</em> Broad but familiar options that cover most non-MDR urinary pathogens.</li>"
          ];
          const reasonsText4 = [
            "Ceftriaxone/pip‚Äìtazo: broad, familiar agents covering most non-MDR urinary pathogens."
          ];
          addRegimen("Standard cUTI/urosepsis backbone", "Standard cUTI/urosepsis backbone:", bulletsHtml4, bulletsText4, reasonsHtml4, reasonsText4);
        }
      } else {
        abxHtml += "<p>Specify UTI type (cystitis, pyelonephritis, or complicated/CAUTI) to refine empiric recommendations.</p>";
        abxTextLines.push("Specify UTI type (cystitis, pyelonephritis, complicated/CAUTI) to refine empiric recommendations.");
      }

      // Allergy considerations for UTI
      const allergyNotes = [];
      if (algSulfa && /TMP‚ÄìSMX|TMP-?SMX/i.test(abxHtml)) {
        allergyNotes.push("Sulfa/TMP‚ÄìSMX allergy selected; avoid regimens that rely on TMP‚ÄìSMX.");
      }
      if (algFq && /fluoroquinolone|levofloxacin|moxifloxacin|ciprofloxacin/i.test(abxHtml)) {
        allergyNotes.push("Fluoroquinolone allergy selected; avoid ciprofloxacin, levofloxacin, and related agents.");
      }
      if ((algPen || algCeph) && /cef|amox|piperacillin|tazobactam|meropenem|imipenem|ertapenem/i.test(abxHtml)) {
        allergyNotes.push("Penicillin/cephalosporin allergy selected; carefully assess before using Œ≤-lactams (ceftriaxone, pip‚Äìtazo, etc.).");
      }
      if (algCarb && /meropenem|imipenem|ertapenem|carbapenem/i.test(abxHtml)) {
        allergyNotes.push("Carbapenem allergy selected; avoid meropenem, imipenem, ertapenem, and related agents.");
      }
      if (allergyNotes.length) {
        abxHtml += "<p><strong>Allergy considerations (UTI):</strong></p><ul>";
        allergyNotes.forEach(n => abxHtml += "<li>" + n + "</li>");
        abxHtml += "</ul>";
        allergyNotes.forEach(n => abxTextLines.push("Allergy note (UTI): " + n));
      }

      return {
        summaryHtml: summaryParts.join(" "),
        abxHtml,
        textSummary: summaryTextParts.join(" "),
        textAbx: abxTextLines.join("\n")
      };
    }

    function buildOtherSitesSummary() {
      const sites = [];
      if (document.getElementById("site-ssti").checked) sites.push("skin / soft tissue infection");
      if (document.getElementById("site-iab").checked) sites.push("intra-abdominal infection");
      if (document.getElementById("site-bacteremia").checked) sites.push("bacteremia");
      if (document.getElementById("site-unknown").checked) sites.push("sepsis with unclear source");

      if (!sites.length) return { html: "", text: "" };

      const text = "Other suspected sites: " + sites.join(", ") +
        ". For these, anchor therapy in source control, prior cultures, and local guidelines; this wizard version primarily details pneumonia and UTI regimens.";
      const html = "<strong>Other suspected sites:</strong> " + sites.join(", ") +
        ". For these, anchor therapy in source control, prior cultures, and local guidelines; this version primarily details pneumonia and UTI regimens.";
      return { html, text };
    }

    function buildDiagnosticsPlan() {
      const partsHtml = [];
      const partsText = [];
      const setting = getSetting();
      const sitePna = document.getElementById("site-pneumonia").checked;
      const siteUti = document.getElementById("site-uti").checked;
      const mrsaRisk = document.getElementById("pna-mrsa-prior").checked ||
        countChecked([
          "pna-mrsa-ivabx",
          "pna-mrsa-flu",
          "pna-mrsa-cavitary",
          "pna-mrsa-esrd"
        ]) > 0;

      if (sitePna) {
        partsHtml.push("<h4>Pneumonia</h4>");
        partsHtml.push("<ul>" +
          "<li>Obtain chest imaging (CXR; CT if atypical or not improving).</li>" +
          "<li>For severe CAP or when empiric MRSA/Pseudomonas coverage is started: send blood cultures and sputum culture <em>before</em> antibiotics when feasible.</li>" +
          (mrsaRisk ? "<li>Order MRSA nasal swab; if negative and no strong risk, discontinue MRSA coverage.</li>" : "") +
          "</ul>");
        partsText.push("Pneumonia diagnostics:");
        partsText.push("  - Chest imaging (CXR; CT if atypical or not improving).");
        partsText.push("  - For severe CAP or when empiric MRSA/Pseudomonas coverage is started: blood cultures and sputum culture before antibiotics when feasible.");
        if (mrsaRisk) {
          partsText.push("  - MRSA nasal swab; if negative and no strong risk, discontinue MRSA coverage.");
        }
      }

      if (siteUti) {
        partsHtml.push("<h4>UTI / CAUTI</h4>");
        partsHtml.push("<ul>" +
          "<li>Send urinalysis and urine culture <strong>before</strong> antibiotics whenever possible.</li>" +
          "<li>For suspected CAUTI, change/remove the catheter just before collecting culture.</li>" +
          "<li>In pyelonephritis or urosepsis, obtain blood cultures and consider renal/bladder imaging if not improving or obstruction suspected.</li>" +
          "</ul>");
        partsText.push("UTI/CAUTI diagnostics:");
        partsText.push("  - Urinalysis and urine culture before antibiotics when possible.");
        partsText.push("  - For CAUTI: change/remove catheter just before culture.");
        partsText.push("  - In pyelonephritis/urosepsis: blood cultures and consider renal/bladder imaging if not improving or obstruction suspected.");
      }

      if (setting === "icu" || document.getElementById("site-unknown").checked) {
        partsHtml.push("<h4>Sepsis / ICU</h4>");
        partsHtml.push("<ul>" +
          "<li>Follow sepsis bundle: timely cultures, broad empiric coverage adjusted to risk, and rapid reassessment.</li>" +
          "<li>Use local antibiogram (ICU- or UTI-specific, if available) to choose initial IV therapy, especially when shock is present.</li>" +
          "</ul>");
        partsText.push("Sepsis/ICU diagnostics and stewardship:");
        partsText.push("  - Follow sepsis bundle: timely cultures, broad empiric coverage adjusted to risk, rapid reassessment.");
        partsText.push("  - Use local antibiogram (ICU- or site-specific) to choose initial IV therapy, especially with shock.");
      }

      if (!partsHtml.length) {
        return {
          html: "<p>Diagnostics and culture guidance will populate once at least one site (e.g., pneumonia or UTI) is selected.</p>",
          text: "Diagnostics: will populate once at least one site (e.g., pneumonia or UTI) is selected."
        };
      }
      return {
        html: partsHtml.join(""),
        text: partsText.join("\n")
      };
    }

    function runWizard() {
      const age = Number(document.getElementById("age").value || "0");
      const sex = document.getElementById("sex").value;
      const setting = getSetting();

      const sitePna = document.getElementById("site-pneumonia").checked;
      const siteUti = document.getElementById("site-uti").checked;
      const anySite = sitePna || siteUti ||
        document.getElementById("site-ssti").checked ||
        document.getElementById("site-iab").checked ||
        document.getElementById("site-bacteremia").checked ||
        document.getElementById("site-unknown").checked;

      const pnaPlan = buildPneumoniaPlan();
      const utiPlan = buildUtiPlan();
      const otherSites = buildOtherSitesSummary();
      const diagnostics = buildDiagnosticsPlan();
      const allergySummary = getAllergySummary();

      const summaryEl = document.getElementById("summary-content");
      const abxEl = document.getElementById("abx-content");
      const diagEl = document.getElementById("diagnostics-content");

      if (!anySite) {
        summaryEl.innerHTML = "<p>Please select at least one suspected infection site to generate an empiric plan.</p>";
        abxEl.innerHTML = "<p>No sites selected. Choose pneumonia, UTI, or other sites to see specific suggestions.</p>";
        diagEl.innerHTML = "<p>Once a site is selected, this section will outline which cultures and imaging to obtain.</p>";
        currentPlanText = "";
        return;
      }

      // Build high-level summary HTML/text
      const summaryBitsHtml = [];
      const summaryBitsText = [];

      if (age) {
        summaryBitsHtml.push("Age " + age + " years.");
        summaryBitsText.push("Age " + age + " years.");
      }
      if (sex) {
        summaryBitsHtml.push("Sex: " + sex + ".");
        summaryBitsText.push("Sex: " + sex + ".");
      }
      if (setting === "outpatient") {
        summaryBitsHtml.push("Managing as outpatient / ambulatory.");
        summaryBitsText.push("Managing as outpatient / ambulatory.");
      }
      if (setting === "inpatient") {
        summaryBitsHtml.push("Hospitalized on ward / non-ICU.");
        summaryBitsText.push("Hospitalized on ward / non-ICU.");
      }
      if (setting === "icu") {
        summaryBitsHtml.push("ICU / severe illness.");
        summaryBitsText.push("ICU / severe illness.");
      }

      summaryBitsHtml.push(allergySummary);
      summaryBitsText.push(allergySummary);

      if (pnaPlan.summaryHtml) {
        summaryBitsHtml.push(pnaPlan.summaryHtml);
        summaryBitsText.push(pnaPlan.textSummary);
      }
      if (utiPlan.summaryHtml) {
        summaryBitsHtml.push(utiPlan.summaryHtml);
        summaryBitsText.push(utiPlan.textSummary);
      }
      if (otherSites.html) {
        summaryBitsHtml.push(otherSites.html);
        summaryBitsText.push(otherSites.text);
      }

      summaryBitsHtml.push("Always cross-check with local antibiograms, allergy profile, organ function, and ID consultation when needed.");
      summaryBitsText.push("Always cross-check with local antibiograms, allergy profile, organ function, and ID consultation when needed.");

      summaryEl.innerHTML = "<p>" + summaryBitsHtml.join(" ") + "</p>";

      // Antibiotics HTML/text
      const abxBlocksHtml = [];
      const abxBlocksText = [];

      if (pnaPlan.abxHtml) {
        abxBlocksHtml.push("<h3>ü´Å Pneumonia regimen</h3>" + pnaPlan.abxHtml);
        abxBlocksText.push("Pneumonia regimen:");
        abxBlocksText.push(pnaPlan.textAbx);
      }
      if (utiPlan.abxHtml) {
        abxBlocksHtml.push("<h3>üíß UTI regimen</h3>" + utiPlan.abxHtml);
        abxBlocksText.push("UTI regimen:");
        abxBlocksText.push(utiPlan.textAbx);
      }

      if (!abxBlocksHtml.length) {
        abxBlocksHtml.push("<p>No detailed regimen could be generated for the selected inputs. Check that pneumonia or UTI type and severity are specified, or use this as a prompt to think through local guidelines.</p>");
        abxBlocksText.push("No detailed regimen generated; ensure pneumonia/UTI type and severity are specified.");
      } else {
        abxBlocksHtml.push("<p><strong>De-escalation:</strong> Narrow therapy within 48‚Äì72 hours based on cultures, susceptibilities, and clinical response.</p>");
        abxBlocksText.push("De-escalation: narrow therapy within 48‚Äì72 hours based on cultures, susceptibilities, and clinical response.");
      }

      abxEl.innerHTML = abxBlocksHtml.join("<hr>");
      diagEl.innerHTML = diagnostics.html;

      // Build plain text plan for copy
      const planLines = [];
      planLines.push("=== SUMMARY ===");
      planLines.push(summaryBitsText.join(" "));
      planLines.push("");
      planLines.push("=== EMPIRIC ANTIBIOTICS ===");
      planLines.push(abxBlocksText.join("\n"));
      planLines.push("");
      planLines.push("=== DIAGNOSTICS & CULTURES ===");
      planLines.push(diagnostics.text);
      planLines.push("");
      planLines.push("Note: Educational support tool. Confirm with local guidelines, antibiogram, and ID consult.");

      currentPlanText = planLines.join("\n");
    }

    function openCopyModal() {
      if (!currentPlanText) {
        alert("Run the wizard first to generate a plan, then you can preview and copy it.");
        return;
      }
      const overlay = document.getElementById("copy-modal-overlay");
      const ta = document.getElementById("copy-modal-textarea");
      ta.value = currentPlanText;
      overlay.style.display = "flex";
      overlay.setAttribute("aria-hidden", "false");
    }

    function closeCopyModal() {
      const overlay = document.getElementById("copy-modal-overlay");
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden", "true");
    }

    function copyPlanToClipboard() {
      if (!currentPlanText) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentPlanText)
          .then(() => {
            alert("Plan copied to clipboard.");
          })
          .catch(() => {
            fallbackCopy();
          });
      } else {
        fallbackCopy();
      }
    }

    function fallbackCopy() {
      const ta = document.getElementById("copy-modal-textarea");
      ta.select();
      try {
        document.execCommand("copy");
        alert("Plan copied to clipboard.");
      } catch {
        alert("Unable to copy automatically. You can manually select and copy the text.");
      }
    }
  </script>
</body>
</html>
